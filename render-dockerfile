# Stage 1: build headscale
FROM golang:1.21 AS builder

WORKDIR /src
RUN git clone https://github.com/juanfont/headscale.git
WORKDIR /src/headscale
RUN make build

# Stage 2: runtime
FROM debian:bookworm-slim

# Install HAProxy + dependencies
RUN apt-get update && \
    apt-get install -y haproxy ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Copy headscale binary
COPY --from=builder /src/headscale/headscale /usr/local/bin/headscale

# pull configs from github repo
RUN git clone https://github.com/purethunder110/scalestruct.git

# Copy configs
COPY scalestruct/headscale-config.yaml /etc/headscale/config.yaml
COPY scalestruct/render-haproxy.cfg /etc/haproxy/haproxy.cfg

# Create data dir
RUN mkdir -p /var/lib/headscale

# EXPOSE 80 443 8080 25565 5432 3478/udp

EXPOSE 80 443

CMD ["/bin/sh", "-c", "\
    headscale serve --config /etc/headscale/config.yaml & \
    haproxy -f /etc/haproxy/haproxy.cfg -db \
"]
